<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Validador AFD Portaria 671" />
    <meta name="keywords" content="afd, portaria, 671, rep-c" />
    <meta name="author" content="Douglas Silva" />
    <title>Listar tipos de linhas no AFD 671</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Listar tipos de linhas no AFD 671</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="file" class="label-file">Escolher arquivo</label>
        <input type="file" id="file" name="file" required onchange="updateFileName()" />
        <span id="file-name">Nenhum arquivo selecionado</span>
        <br />
        <button type="submit">Listar</button>
      </form>

      <div class="buttons">
        <button data-tooltip="Registros do tipo 2 (IdentificaÃ§Ã£o da empresa no REP)" onclick="filterByType('2')">Tipo 2</button>
        <button data-tooltip="Registros do tipo 3 (MarcaÃ§Ã£o de ponto para REP-C e REP-A)" onclick="filterByType('3')">Tipo 3</button>
        <button data-tooltip="Registros do tipo 4 (Ajuste do relÃ³gio)" onclick="filterByType('4')">Tipo 4</button>
        <button data-tooltip="Registros do tipo 5 (InclusÃ£o, alteraÃ§Ã£o ou exclusÃ£o de empregado no REP)" onclick="filterByType('5')">Tipo 5</button>
        <button data-tooltip="Registros do tipo 6 (Eventos sensÃ­veis do REP)" onclick="filterByType('6')">Tipo 6</button>
        <button data-tooltip="Mostrar todos os registros" onclick="filterByType('all')">Todos</button>
      </div>

      <h2>Resultado</h2>
      <pre id="resultado"></pre>
    </div>

    <script>
      let registrosData = {};

      // Mapeamento dos tÃ­tulos completos para os tipos de registros
      const tipoRegistroDescricao = {
        2: 'Tipo 2: Registros do tipo 2 (IdentificaÃ§Ã£o da empresa no REP):',
        3: 'Tipo 3: Registros do tipo 3 (MarcaÃ§Ã£o de ponto para REP-C e REP-A):',
        4: 'Tipo 4: Registros do tipo 4 (Ajuste do relÃ³gio):',
        5: 'Tipo 5: Registros do tipo 5 (InclusÃ£o, alteraÃ§Ã£o ou exclusÃ£o de empregado no REP):',
        6: 'Tipo 6: Registros do tipo 6 (Eventos sensÃ­veis do REP):',
      };

      document.getElementById('uploadForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('file', document.getElementById('file').files[0]);

        fetch('http://10.1.2.28:56000/upload', {
          method: 'POST',
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Resposta do backend:', data);
            registrosData = data.registros || {};
            displayResult(registrosData);
          })
          .catch((error) => {
            console.error('Erro:', error);
          });
      });

      function updateFileName() {
        const input = document.getElementById('file');
        const fileName = document.getElementById('file-name');

        if (input.files.length > 0) {
          fileName.textContent = input.files[0].name; // Exibe o nome do arquivo escolhido
        } else {
          fileName.textContent = 'Nenhum arquivo selecionado';
        }
      }

      function displayResult(data) {
        const resultadoElement = document.getElementById('resultado');
        let resultadoText = '';

        for (const tipo in data) {
          let registros = data[tipo];

          if (!Array.isArray(registros)) {
            console.warn(`Tipo ${tipo} nÃ£o Ã© um array. Convertendo...`);
            registros = Object.values(registros);
          }

          resultadoText += `${tipoRegistroDescricao[tipo] || `Tipo ${tipo}:`}\n`;

          if (registros.length === 0) {
            resultadoText += 'Nenhum registro encontrado.\n';
          } else {
            registros.forEach((linha) => {
              resultadoText += linha + '\n';
            });
          }
          resultadoText += '-'.repeat(40) + '\n';
        }

        // ðŸ”¥ Garante que o texto seja tratado corretamente no HTML
        resultadoElement.textContent = resultadoText.normalize('NFC');
      }

      function filterByType(tipo) {
        let filteredData = {};
        if (tipo === 'all') {
          filteredData = registrosData;
        } else {
          filteredData[tipo] = registrosData[tipo] || [];
        }
        displayResult(filteredData);
      }
    </script>
  </body>
</html>
