<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Validador AFD Portaria 671" />
    <meta name="keywords" content="afd, portaria, 671, rep-c" />
    <meta name="author" content="Douglas Silva" />
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=1" />
    <title>AFD Expert 671</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>AFD Expert 671</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="file" class="label-file">Escolher arquivo</label>
        <input type="file" id="file" name="file" required onchange="updateFileName()" />
        <span id="file-name">Nenhum arquivo selecionado</span>
        <br />
        <div class="button-group">
          <button type="submit">Listar</button>
          <button type="button" onclick="clearFile()">Limpar</button>
        </div>
      </form>

      <div class="buttons">
        <button data-tooltip="Exibe detalhes do arquivo ou registro" onclick="showDetails()">Detalhes</button>
        <button data-tooltip="Mostrar todos os registros" onclick="filterByType('all')">Todos</button>
        <button data-tooltip="Registros do tipo 2 (Identifica칞칚o da empresa no REP)" onclick="filterByType('2')">Tipo 2</button>
        <button data-tooltip="Registros do tipo 3 (Marca칞칚o de ponto para REP-C e REP-A)" onclick="filterByType('3')">Tipo 3</button>
        <button data-tooltip="Registros do tipo 4 (Ajuste do rel칩gio)" onclick="filterByType('4')">Tipo 4</button>
        <button data-tooltip="Registros do tipo 5 (Inclus칚o, altera칞칚o ou exclus칚o de empregado no REP)" onclick="filterByType('5')">Tipo 5</button>
        <button data-tooltip="Registros do tipo 6 (Eventos sens칤veis do REP)" onclick="filterByType('6')">Tipo 6</button>
        <button data-tooltip="Linhas que n칚o atendem a nenhum tipo" onclick="filterInvalidLines()">Linhas inv치lidas</button>
        <button data-tooltip="Pesquisar dentro do arquivo carregado" onclick="toggleSearch()">Pesquisar</button>
      </div>

      <h2>Resultado</h2>

      <div id="searchArea" style="display: none">
        <input type="text" id="searchInput" placeholder="Digite o termo de pesquisa" />
        <button id="searchButton" onclick="performSearch()">Buscar</button>
      </div>
      <pre id="resultado"></pre>
    </div>

    <script>
      let registrosData = {};

      // Fun칞칚o para ocultar o campo de pesquisa
      function hideSearchArea() {
        const searchArea = document.getElementById('searchArea');
        searchArea.style.display = 'none';
      }

      // Fun칞칚o para alternar a visibilidade do campo de pesquisa
      function toggleSearch() {
        console.log('Fun칞칚o toggleSearch chamada.');

        const searchArea = document.getElementById('searchArea'); // Captura a 치rea de pesquisa
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resultadoElement = document.getElementById('resultado'); // Captura a 치rea de resultados

        console.log('searchArea:', searchArea);
        console.log('searchInput:', searchInput);
        console.log('searchButton:', searchButton);
        console.log('resultadoElement:', resultadoElement);

        if (searchArea && searchInput && searchButton && resultadoElement) {
          // Alterna a visibilidade da 치rea de pesquisa
          if (searchArea.style.display === 'none' || searchArea.style.display === '') {
            searchArea.style.display = 'block'; // Exibe a 치rea de pesquisa
            searchInput.style.display = 'inline-block'; // Exibe o campo de pesquisa
            searchButton.style.display = 'inline-block'; // Exibe o bot칚o de busca

            // Limpa o conte칰do da 치rea de resultados
            resultadoElement.textContent = '';
          } else {
            searchArea.style.display = 'none'; // Oculta a 치rea de pesquisa
            searchInput.style.display = 'none'; // Oculta o campo de pesquisa
            searchButton.style.display = 'none'; // Oculta o bot칚o de busca
          }
        } else {
          console.error('Elementos searchArea, searchInput, searchButton ou resultadoElement n칚o encontrados no DOM.');
        }
      }

      // Fun칞칚o para formatar data no formato dd-mm-yyyy
      function formatDate(dateStr) {
        console.log('Data recebida:', dateStr);
        if (!dateStr) return 'Data inv치lida';

        const [year, month, day] = dateStr.split('-');
        const dateObj = new Date(Date.UTC(year, month - 1, day));

        if (isNaN(dateObj)) return 'Data inv치lida';

        const dayFormatted = String(dateObj.getUTCDate()).padStart(2, '0');
        const monthFormatted = String(dateObj.getUTCMonth() + 1).padStart(2, '0');
        const yearFormatted = dateObj.getUTCFullYear();

        return `${dayFormatted}-${monthFormatted}-${yearFormatted}`;
      }

      // Fun칞칚o para formatar data e hora no formato dd-mm-yyyy HH:MM:SS (sem fuso hor치rio)
      function formatDateTime(dateTimeStr) {
        console.log('Data e hora recebida:', dateTimeStr);
        if (!dateTimeStr) return 'Data e hora inv치lida';

        const [datePart, timePart] = dateTimeStr.split('T');
        if (!datePart || !timePart) return 'Data e hora inv치lida';

        const [year, month, day] = datePart.split('-');
        if (!year || !month || !day) return 'Data e hora inv치lida';

        const timeWithoutTimezone = timePart.split('-')[0];
        return `${day}-${month}-${year} ${timeWithoutTimezone}`;
      }

      // Mapeamento dos t칤tulos completos para os tipos de registros
      const tipoRegistroDescricao = {
        1: 'Cabe칞alho:',
        2: 'Tipo 2: Registros do tipo 2 (Identifica칞칚o da empresa no REP):',
        3: 'Tipo 3: Registros do tipo 3 (Marca칞칚o de ponto para REP-C e REP-A):',
        4: 'Tipo 4: Registros do tipo 4 (Ajuste do rel칩gio):',
        5: 'Tipo 5: Registros do tipo 5 (Inclus칚o, altera칞칚o ou exclus칚o de empregado no REP):',
        6: 'Tipo 6: Registros do tipo 6 (Eventos sens칤veis do REP):',
      };

      document.getElementById('uploadForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('file', document.getElementById('file').files[0]);

        fetch('http://10.1.2.28:56000/upload', {
          method: 'POST',
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('游늷 Resposta completa do backend:', data);
            registrosData = data;
            displayResult(data.registros);
          })
          .catch((error) => {
            console.error('Erro:', error);
          });
      });

      function updateFileName() {
        const input = document.getElementById('file');
        const fileName = document.getElementById('file-name');

        if (input.files.length > 0) {
          fileName.textContent = input.files[0].name;
        } else {
          fileName.textContent = 'Nenhum arquivo selecionado';
        }
      }

      // Fun칞칚o para limpar o arquivo e o resultado
      function clearFile() {
        hideSearchArea(); // Oculta o campo de pesquisa
        const input = document.getElementById('file');
        const fileName = document.getElementById('file-name');
        const resultadoElement = document.getElementById('resultado');

        input.value = '';
        fileName.textContent = 'Nenhum arquivo selecionado';
        resultadoElement.textContent = '';
        registrosData = {};
      }

      function displayResult(data) {
        const resultadoElement = document.getElementById('resultado');
        let resultadoText = '';

        for (const tipo in data) {
          let registros = data[tipo];

          if (!Array.isArray(registros)) {
            console.warn(`游늷 Tipo ${tipo} n칚o 칠 um array. Convertendo...`);
            registros = Object.values(registros);
          }

          resultadoText += `${tipoRegistroDescricao[tipo] || `Tipo ${tipo}:`}\n`;

          if (registros.length === 0) {
            resultadoText += 'Nenhum registro encontrado.\n';
          } else {
            registros.forEach((linha) => {
              resultadoText += linha + '\n';
            });
          }
          resultadoText += '-'.repeat(40) + '\n';
        }

        resultadoElement.textContent = resultadoText.normalize('NFC');
      }

      function filterByType(tipo) {
        hideSearchArea(); // Oculta o campo de pesquisa
        if (!registrosData || !registrosData.registros) {
          console.warn('游늷 registrosData est치 indefinido ou n칚o cont칠m registros');
          return;
        }

        let filteredData = {};

        if (tipo === 'all') {
          filteredData = registrosData.registros;
        } else {
          filteredData[tipo] = registrosData.registros[tipo] || [];
        }

        displayResult(filteredData);
      }

      function filterInvalidLines() {
        hideSearchArea(); // Oculta o campo de pesquisa
        if (!registrosData || !registrosData.linhasInvalidas) {
          console.warn('游늷 registrosData.linhasInvalidas est치 indefinido ou n칚o cont칠m registros');
          return;
        }

        const invalidLines = registrosData.linhasInvalidas;
        const resultadoElement = document.getElementById('resultado');
        resultadoElement.textContent = '';

        let resultadoText = 'Linhas inv치lidas:\n';
        if (invalidLines.length === 0) {
          resultadoText += 'Nenhuma linha inv치lida encontrada.\n';
        } else {
          invalidLines.forEach((linha) => {
            resultadoText += linha + '\n';
          });
        }

        resultadoElement.textContent = resultadoText;
      }

      function showDetails() {
        hideSearchArea(); // Oculta o campo de pesquisa
        if (!registrosData || !registrosData.registros) {
          console.warn('游늷 registrosData est치 indefinido ou n칚o cont칠m registros');
          return;
        }

        const detalhes = {
          tipo2: 0,
          tipo3: 0,
          tipo4: 0,
          tipo5: 0,
          dataInicio: registrosData.dataInicio ? formatDate(registrosData.dataInicio) : 'N칚o dispon칤vel',
          dataFim: registrosData.dataFim ? formatDate(registrosData.dataFim) : 'N칚o dispon칤vel',
          dataHoraGeracao: registrosData.dataHoraGeracao ? formatDateTime(registrosData.dataHoraGeracao) : 'N칚o dispon칤vel',
          totalLinhas: registrosData.totalLinhas || 0,
          serialEquipamento: 'N칚o dispon칤vel',
          ultimaAlteracaoEmpresa: registrosData.ultimaAlteracaoEmpresa || null,
        };

        if (registrosData.registros[1] && registrosData.registros[1].length > 0) {
          const cabecalho = registrosData.registros[1][0];
          detalhes.serialEquipamento = cabecalho.substring(189, 206).trim();
        }

        for (const tipo in registrosData.registros) {
          let registros = registrosData.registros[tipo];

          if (!Array.isArray(registros)) {
            registros = Object.values(registros);
          }

          if (tipo == '2') detalhes.tipo2 = registros.length;
          if (tipo == '3') detalhes.tipo3 = registros.length;
          if (tipo == '4') detalhes.tipo4 = registros.length;
          if (tipo == '5') detalhes.tipo5 = registros.length;
        }

        const resultadoElement = document.getElementById('resultado');
        let detalhesText = `
Detalhes do arquivo:
----------------------------------------
Data e hora da gera칞칚o do arquivo: ${detalhes.dataHoraGeracao}
Quantidade de linhas no arquivo: ${detalhes.totalLinhas}
Quantidade de registros Tipo 2 (Identifica칞칚o da empresa no REP): ${detalhes.tipo2}
Quantidade de registros Tipo 3 (Marca칞칚o de ponto para REP-C e REP-A): ${detalhes.tipo3}
Quantidade de registros Tipo 4 (Ajuste do rel칩gio): ${detalhes.tipo4}
Quantidade de registros Tipo 5 (Inclus칚o, altera칞칚o ou exclus칚o de empregado no REP): ${detalhes.tipo5}

N췈 serial do equipamento: ${detalhes.serialEquipamento}
Data de in칤cio dos eventos: ${detalhes.dataInicio}
Data de fim dos eventos: ${detalhes.dataFim}
`;

        if (detalhes.ultimaAlteracaoEmpresa) {
          detalhesText += `
칔ltima altera칞칚o da empresa:
Data e hora da grava칞칚o: ${formatDateTime(detalhes.ultimaAlteracaoEmpresa.dataHoraGravacao)}
CNPJ/CPF do empregador: ${detalhes.ultimaAlteracaoEmpresa.cnpjCpfEmpregador}
Raz칚o social: ${detalhes.ultimaAlteracaoEmpresa.razaoSocial}
`;
        }

        resultadoElement.textContent = detalhesText;
      }

      // Fun칞칚o para realizar a pesquisa
      function performSearch() {
        console.log('Fun칞칚o performSearch chamada.');

        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        console.log('Termo de pesquisa:', searchTerm);

        if (!searchTerm) {
          console.warn('Nenhum termo de pesquisa digitado.');
          alert('Por favor, digite um termo para pesquisar.');
          return;
        }

        if (!registrosData || !registrosData.registros) {
          console.warn('Nenhum arquivo carregado para pesquisar.');
          alert('Nenhum arquivo carregado para pesquisar.');
          return;
        }

        const filteredData = {};
        console.log('Dados carregados:', registrosData.registros);

        for (const tipo in registrosData.registros) {
          filteredData[tipo] = registrosData.registros[tipo].filter((linha) => {
            console.log('Linha:', linha);
            return linha.toLowerCase().includes(searchTerm);
          });
        }

        console.log('Dados filtrados:', filteredData);
        displayResult(filteredData); // Exibe os resultados filtrados
      }

      // Captura o campo de pesquisa
      const searchInput = document.getElementById('searchInput');

      // Adiciona um event listener para o evento "keydown"
      searchInput.addEventListener('keydown', function (event) {
        console.log('Tecla pressionada:', event.key);

        // Verifica se a tecla pressionada foi "Enter" (c칩digo 13)
        if (event.key === 'Enter') {
          console.log('Enter pressionado. Executando pesquisa...');
          performSearch(); // Chama a fun칞칚o de pesquisa
        }
      });
    </script>
  </body>
</html>
