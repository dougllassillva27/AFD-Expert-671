<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Validador AFD Portaria 671" />
    <meta name="keywords" content="afd, portaria, 671, rep-c" />
    <meta name="author" content="Douglas Silva" />
    <link rel="icon" type="image/x-icon" href="favicon.ico?v=1" />
    <title>Analisador AFD 671</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>Analisador AFD 671</h1>
      <form id="uploadForm" enctype="multipart/form-data">
        <label for="file" class="label-file">Escolher arquivo</label>
        <input type="file" id="file" name="file" required onchange="updateFileName()" />
        <span id="file-name">Nenhum arquivo selecionado</span>
        <br />
        <div class="button-group">
          <button type="submit">Listar</button>
          <button type="button" onclick="clearFile()">Limpar</button>
        </div>
      </form>

      <div class="buttons">
        <button data-tooltip="Exibe detalhes do arquivo ou registro" onclick="showDetails()">Detalhes</button>
        <button data-tooltip="Registros do tipo 2 (Identifica√ß√£o da empresa no REP)" onclick="filterByType('2')">Tipo 2</button>
        <button data-tooltip="Registros do tipo 3 (Marca√ß√£o de ponto para REP-C e REP-A)" onclick="filterByType('3')">Tipo 3</button>
        <button data-tooltip="Registros do tipo 4 (Ajuste do rel√≥gio)" onclick="filterByType('4')">Tipo 4</button>
        <button data-tooltip="Registros do tipo 5 (Inclus√£o, altera√ß√£o ou exclus√£o de empregado no REP)" onclick="filterByType('5')">Tipo 5</button>
        <button data-tooltip="Registros do tipo 6 (Eventos sens√≠veis do REP)" onclick="filterByType('6')">Tipo 6</button>
        <button data-tooltip="Linhas que n√£o atendem a nenhum tipo" onclick="filterInvalidLines()">Linhas inv√°lidas</button>
        <button data-tooltip="Mostrar todos os registros" onclick="filterByType('all')">Todos</button>
      </div>

      <h2>Resultado</h2>
      <pre id="resultado"></pre>
    </div>

    <script>
      let registrosData = {};

      // Fun√ß√£o para formatar data no formato dd-mm-yyyy
      function formatDate(dateStr) {
        console.log('Data recebida:', dateStr); // Log para depura√ß√£o
        if (!dateStr) return 'Data inv√°lida';

        // Cria a data com Date.UTC, para evitar o ajuste autom√°tico de fuso hor√°rio
        const [year, month, day] = dateStr.split('-'); // Divide a data no formato YYYY-MM-DD
        const dateObj = new Date(Date.UTC(year, month - 1, day)); // M√™s come√ßa do 0 em JavaScript

        if (isNaN(dateObj)) return 'Data inv√°lida'; // Verifica se a data √© v√°lida

        const dayFormatted = String(dateObj.getUTCDate()).padStart(2, '0');
        const monthFormatted = String(dateObj.getUTCMonth() + 1).padStart(2, '0'); // M√™s come√ßa de 0
        const yearFormatted = dateObj.getUTCFullYear();

        return `${dayFormatted}-${monthFormatted}-${yearFormatted}`;
      }

      // Fun√ß√£o para formatar data e hora no formato dd-mm-yyyy HH:MM:SS (sem fuso hor√°rio)
      function formatDateTime(dateTimeStr) {
        console.log('Data e hora recebida:', dateTimeStr); // Log para depura√ß√£o
        if (!dateTimeStr) return 'Data e hora inv√°lida';

        // Divide a string em data e hora
        const [datePart, timePart] = dateTimeStr.split('T');
        if (!datePart || !timePart) return 'Data e hora inv√°lida';

        // Divide a data em ano, m√™s e dia
        const [year, month, day] = datePart.split('-');
        if (!year || !month || !day) return 'Data e hora inv√°lida';

        // Remove o fuso hor√°rio da parte do tempo
        const timeWithoutTimezone = timePart.split('-')[0]; // Remove tudo ap√≥s o '-'

        // Retorna no formato dd-mm-yyyy HH:MM:SS (sem fuso hor√°rio)
        return `${day}-${month}-${year} ${timeWithoutTimezone}`;
      }

      // Mapeamento dos t√≠tulos completos para os tipos de registros
      const tipoRegistroDescricao = {
        1: 'Cabe√ßalho:',
        2: 'Tipo 2: Registros do tipo 2 (Identifica√ß√£o da empresa no REP):',
        3: 'Tipo 3: Registros do tipo 3 (Marca√ß√£o de ponto para REP-C e REP-A):',
        4: 'Tipo 4: Registros do tipo 4 (Ajuste do rel√≥gio):',
        5: 'Tipo 5: Registros do tipo 5 (Inclus√£o, altera√ß√£o ou exclus√£o de empregado no REP):',
        6: 'Tipo 6: Registros do tipo 6 (Eventos sens√≠veis do REP):',
      };

      document.getElementById('uploadForm').addEventListener('submit', function (event) {
        event.preventDefault();

        const formData = new FormData();
        formData.append('file', document.getElementById('file').files[0]);

        fetch('http://10.1.2.28:56000/upload', {
          method: 'POST',
          body: formData,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('üìå Resposta completa do backend:', data); // üîç Verifica o que est√° vindo

            // ‚úÖ Armazena toda a resposta, incluindo registros e totalLinhas
            registrosData = data;

            // ‚úÖ Exibe tudo por padr√£o ao enviar um arquivo
            displayResult(data.registros);
          })
          .catch((error) => {
            console.error('Erro:', error);
          });
      });

      function updateFileName() {
        const input = document.getElementById('file');
        const fileName = document.getElementById('file-name');

        if (input.files.length > 0) {
          fileName.textContent = input.files[0].name; // Exibe o nome do arquivo escolhido
        } else {
          fileName.textContent = 'Nenhum arquivo selecionado';
        }
      }

      // Fun√ß√£o para limpar o arquivo e o resultado
      function clearFile() {
        const input = document.getElementById('file');
        const fileName = document.getElementById('file-name');
        const resultadoElement = document.getElementById('resultado');

        // Limpa o campo de arquivo
        input.value = '';
        fileName.textContent = 'Nenhum arquivo selecionado';

        // Limpa o campo de resultado
        resultadoElement.textContent = '';

        // Limpa os dados armazenados
        registrosData = {};
      }

      function displayResult(data) {
        const resultadoElement = document.getElementById('resultado');
        let resultadoText = '';

        for (const tipo in data) {
          let registros = data[tipo];

          if (!Array.isArray(registros)) {
            console.warn(`üìå Tipo ${tipo} n√£o √© um array. Convertendo...`);
            registros = Object.values(registros);
          }

          resultadoText += `${tipoRegistroDescricao[tipo] || `Tipo ${tipo}:`}\n`;

          if (registros.length === 0) {
            resultadoText += 'Nenhum registro encontrado.\n';
          } else {
            registros.forEach((linha) => {
              resultadoText += linha + '\n';
            });
          }
          resultadoText += '-'.repeat(40) + '\n';
        }

        resultadoElement.textContent = resultadoText.normalize('NFC');
      }

      function filterByType(tipo) {
        if (!registrosData || !registrosData.registros) {
          console.warn('üìå registrosData est√° indefinido ou n√£o cont√©m registros');
          return;
        }

        let filteredData = {};

        if (tipo === 'all') {
          filteredData = registrosData.registros; // ‚úÖ Mostra todos os registros
        } else {
          filteredData[tipo] = registrosData.registros[tipo] || []; // ‚úÖ Filtra corretamente
        }

        displayResult(filteredData);
      }

      function showDetails() {
        if (!registrosData || !registrosData.registros) {
          console.warn('üìå registrosData est√° indefinido ou n√£o cont√©m registros');
          return;
        }

        const detalhes = {
          tipo2: 0,
          tipo3: 0,
          tipo4: 0,
          tipo5: 0,
          dataInicio: registrosData.dataInicio ? formatDate(registrosData.dataInicio) : 'N√£o dispon√≠vel',
          dataFim: registrosData.dataFim ? formatDate(registrosData.dataFim) : 'N√£o dispon√≠vel',
          dataHoraGeracao: registrosData.dataHoraGeracao ? formatDateTime(registrosData.dataHoraGeracao) : 'N√£o dispon√≠vel', // Formatar data e hora
          totalLinhas: registrosData.totalLinhas || 0,
          serialEquipamento: 'N√£o dispon√≠vel', // Novo campo para o N¬∫ Serial do equipamento
          ultimaAlteracaoEmpresa: registrosData.ultimaAlteracaoEmpresa || null, // √öltima altera√ß√£o da empresa
        };

        // Extrair o N¬∫ Serial do equipamento do cabe√ßalho (Tipo 1)
        if (registrosData.registros[1] && registrosData.registros[1].length > 0) {
          const cabecalho = registrosData.registros[1][0]; // Primeiro registro do tipo 1
          detalhes.serialEquipamento = cabecalho.substring(189, 206).trim(); // Posi√ß√µes 190-206
        }

        for (const tipo in registrosData.registros) {
          let registros = registrosData.registros[tipo];

          if (!Array.isArray(registros)) {
            registros = Object.values(registros);
          }

          if (tipo == '2') detalhes.tipo2 = registros.length;
          if (tipo == '3') detalhes.tipo3 = registros.length;
          if (tipo == '4') detalhes.tipo4 = registros.length;
          if (tipo == '5') detalhes.tipo5 = registros.length;
        }

        const resultadoElement = document.getElementById('resultado');
        let detalhesText = `
Detalhes do arquivo:
----------------------------------------
Data e hora da gera√ß√£o do arquivo: ${detalhes.dataHoraGeracao}
Quantidade de linhas no arquivo: ${detalhes.totalLinhas}
Quantidade de registros Tipo 2 (Identifica√ß√£o da empresa no REP): ${detalhes.tipo2}
Quantidade de registros Tipo 3 (Marca√ß√£o de ponto para REP-C e REP-A): ${detalhes.tipo3}
Quantidade de registros Tipo 4 (Ajuste do rel√≥gio): ${detalhes.tipo4}
Quantidade de registros Tipo 5 (Inclus√£o, altera√ß√£o ou exclus√£o de empregado no REP): ${detalhes.tipo5}

N¬∫ serial do equipamento: ${detalhes.serialEquipamento}
Data de in√≠cio dos eventos: ${detalhes.dataInicio}
Data de fim dos eventos: ${detalhes.dataFim}
`;

        // Adicionar informa√ß√µes da √∫ltima altera√ß√£o da empresa
        if (detalhes.ultimaAlteracaoEmpresa) {
          detalhesText += `
√öltima altera√ß√£o da empresa:
Data e hora da grava√ß√£o: ${formatDateTime(detalhes.ultimaAlteracaoEmpresa.dataHoraGravacao)}
CNPJ/CPF do empregador: ${detalhes.ultimaAlteracaoEmpresa.cnpjCpfEmpregador}
Raz√£o social: ${detalhes.ultimaAlteracaoEmpresa.razaoSocial}
`;
        }

        resultadoElement.textContent = detalhesText;
      }

      // Fun√ß√£o para converter string de data para objeto Date
      function parseDate(dataStr) {
        const year = parseInt(dataStr.substring(0, 4), 10);
        const month = parseInt(dataStr.substring(4, 6), 10) - 1; // Meses come√ßam do 0
        const day = parseInt(dataStr.substring(6, 8), 10);
        return new Date(year, month, day);
      }

      // Fun√ß√£o para filtrar e exibir as linhas inv√°lidas
      function filterInvalidLines() {
        if (!registrosData || !registrosData.linhasInvalidas) {
          console.warn('üìå registrosData.linhasInvalidas est√° indefinido ou n√£o cont√©m registros');
          return;
        }

        // Obter as linhas inv√°lidas retornadas pelo backend
        const invalidLines = registrosData.linhasInvalidas;

        // Limpa o conte√∫do anterior antes de exibir as linhas inv√°lidas
        const resultadoElement = document.getElementById('resultado');
        resultadoElement.textContent = ''; // Limpa qualquer texto anterior

        // Exibir as linhas inv√°lidas
        let resultadoText = 'Linhas inv√°lidas:\n';
        if (invalidLines.length === 0) {
          resultadoText += 'Nenhuma linha inv√°lida encontrada.\n';
        } else {
          invalidLines.forEach((linha) => {
            resultadoText += linha + '\n';
          });
        }

        // Atualiza o conte√∫do da div resultado com as linhas inv√°lidas
        resultadoElement.textContent = resultadoText;
      }
    </script>
  </body>
</html>
